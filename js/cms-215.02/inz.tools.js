var inz=inz||{};inz.tools=inz.tools||{};inz.tools.version="1.12";inz.tools._extend=function(Child,Parent){Child.prototype=inz.tools._inherit(Parent.prototype);Child.prototype.constructor=Child;Child.parent=Parent.prototype};inz.tools._inherit=function inherit(proto){function F(){};F.prototype=proto;return new F};inz.tools._getProperties=function(obj,path,reduce){if(obj==null){return[]}var propertyRE=/^@([a-z0-9_\-]+)=(.+)$/i;function parsePart(context,pathPart){var matches=[];var targets=[context];if(Object.prototype.toString.call(context)==="[object Array]"){targets=context}var prm=propertyRE.exec(pathPart);for(var t=0;t<targets.length;t++){if(prm){if(targets[t][prm[1]]==prm[2]){matches.push(targets[t])}continue}if(targets[t][pathPart]!=null){matches.push(targets[t][pathPart])}}return matches}var properties=[obj];var pathParts=path.split("/");for(var n=0;n<pathParts.length&&properties.length>0;n++){for(var p=properties.length-1;p>=0;p--){var partMatches=parsePart(properties[p],pathParts[n]);properties.splice(p,1);for(var m=0;m<partMatches.length;m++){properties.splice(p+m,0,partMatches[m])}}}if(reduce){return properties.length>0?properties[0]:null}return properties};inz.tools.Tool=function(options){this.debug=false;this.filtersTitle="Use these filters to refine your search";this.filtersCallToActionLabel="Search";this.disableMaps=false;this.includeResetButton=false;this.searchOnInit=true;if(options){for(var key in options){if(options.hasOwnProperty(key)){this[key]=options[key]}}}};inz.tools.Tool.prototype.getFiltersTitle=function(){return this.filtersTitle};inz.tools.Tool.prototype.getFiltersCallToActionLabel=function(){return this.filtersCallToActionLabel};inz.tools.Tool.prototype.getInitialFields=function(){return[]};inz.tools.Tool.prototype.search=function(fieldData,callback){if(this.debug){console.log(fieldData)}callback({type:"ERROR",title:"ERROR",message:"<p>Search not implemented.</p>"})};inz.tools.Tool.prototype._validateField=function(fieldData,field){var fieldDataItem=inz.tools._getProperties(fieldData,"@name="+field.name,true);if(field.required&&(!fieldDataItem||!fieldDataItem.value)){return{name:field.name,text:field.placeholder+" is required"}}if(!fieldDataItem){return}var value=fieldDataItem.value;if(field.type=="select"){if(!(!field.required&&value=="")&&inz.tools._getProperties(field.options,"@value="+value).length<1){return{name:field.name,text:field.placeholder+" is not a valid value"}}}};inz.tools.Tool.prototype.validateFieldData=function(fieldData){var errors=[];for(var n=0,l=this.getInitialFields().length,error;n<l;n++){error=this._validateField(fieldData,this.getInitialFields()[n]);if(error!=null){errors.push(error)}}return errors};inz.tools.LocalTool=function(initialFields,searchConfig,primaryCategory,entityTitle,data,options){inz.tools.LocalTool.parent.constructor.apply(this,[options]);this.initialFields=initialFields;this.searchConfig=searchConfig;this.primaryCategory=primaryCategory;this.entityTitle=entityTitle;this.data=data};inz.tools._extend(inz.tools.LocalTool,inz.tools.Tool);inz.tools.LocalTool.prototype.getInitialFields=function(){return this.initialFields};inz.tools.LocalTool.prototype.search=function(fieldData,callback){if(this.debug){console.log("fieldData",fieldData);var original_callback=callback;callback=function(o){console.log("search result: ",o);original_callback(o)}}var errors=this.validateFieldData(fieldData);if(errors.length){callback({type:"VALIDATION FAIL",errors:errors});return}if(this._getFieldValue(fieldData,"keyword")=="error"){callback({type:"ERROR",title:"ERROR",message:"<p>Super fake error triggered. <i>Super fake!</i></p>"});return}if(this.primaryCategory){var primaryCategoryValue=this._getFieldValue(fieldData,this.primaryCategory);if(primaryCategoryValue){var primaryResults=this._getResults(inz.tools._getProperties(this.searchConfig,"@field="+this.primaryCategory),fieldData);if(primaryResults.length<1){callback({type:"NO RESULTS FOR CATEGORY",category:this.primaryCategory,entityTitle:this._getNoResultsTitle(),message:this._getNoResultsForCategoryMessage(this.primaryCategory,primaryCategoryValue)});return}}}var results=this._getResults(this.searchConfig,fieldData);if(results.length<1){callback({type:"NO RESULTS",entityTitle:this.entityTitle,message:"<p>There are no results that match your search criteria.</p>"});return}callback({type:"RESULTS",entityTitle:this.entityTitle,hasGeolocatedResults:inz.tools._getProperties(results,"location").length>0,count:results.length,data:results});return};inz.tools.LocalTool.prototype._getResults=function(searchConfig,fieldData){var results=[];var fieldRE=/[^a-z0-9\- ]/i;for(var d=0,exclude;d<this.data.length;d++){exclude=false;for(var sc=0,match;sc<searchConfig.length&&!exclude;sc++){var fieldValue=this._getFieldValue(fieldData,searchConfig[sc].field);if(!fieldValue){continue}match=false;for(var m=0,values;m<searchConfig[sc].match.length&&!match;m++){values=inz.tools._getProperties(this.data[d],searchConfig[sc].match[m]);for(var v=0;v<values.length&&!match;v++){switch(searchConfig[sc].type){case"exact":if(values[v]==fieldValue){match=true}break;case"fuzzy":var saferFieldValue=fieldValue.replace(fieldRE,"");if(new RegExp(saferFieldValue,"i").test(values[v])){match=true}break}}}if(!match){exclude=true}}if(!exclude){results.push(this.data[d])}}return results};inz.tools.LocalTool.prototype._getFieldValue=function(fieldData,name){var fieldValues=inz.tools._getProperties(fieldData,"@name="+name+"/value");var fieldValue=null;for(var fv=0;fv<fieldValues.length;fv++){if(fieldValues[fv]){fieldValue=fieldValues[fv];break}}return fieldValue};inz.tools.LocalTool.prototype._getNoResultsForCategoryMessage=function(primaryCategory,primaryCategoryValue){var field=inz.tools._getProperties(this.getInitialFields(),"@name="+primaryCategory,true);var fieldOptionLabel=primaryCategoryValue?inz.tools._getProperties(field,"options/@value="+primaryCategoryValue+"/label"):null;if(this.entityTitle&&fieldOptionLabel){return"INZ has no "+this.entityTitle.toLowerCase()+" in "+fieldOptionLabel}return"There are no results for the specified "+field.placeholder};inz.tools.LocalTool.prototype._getNoResultsTitle=function(){return this.entityTitle};inz.tools.PanelPhysiciansTool=function(initialFields,searchConfig,primaryCategory,entityTitle,data,options){inz.tools.PanelPhysiciansTool.parent.constructor.apply(this,[initialFields,searchConfig,primaryCategory,entityTitle,data,options])};inz.tools._extend(inz.tools.PanelPhysiciansTool,inz.tools.LocalTool);inz.tools.PanelPhysiciansTool.prototype._getNoResultsForCategoryMessage=function(primaryCategory,primaryCategoryValue){var field=inz.tools._getProperties(this.getInitialFields(),"@name="+primaryCategory,true);var fieldOptionLabel=primaryCategoryValue?inz.tools._getProperties(field,"options/@value="+primaryCategoryValue+"/label"):null;if(this.entityTitle&&fieldOptionLabel){var healthEvidenceHtml=this.healthEvidenceURL?'<p><a class="link__internal" href="'+this.healthEvidenceURL+'"><span class="link__title">Evidence you are in good health</span></a></p>':"";var gettingMedicalsHtml=this.gettingMedicalsURL?'<p>Find out what you need including the medical certificate forms:</p><p><a class="link__internal" href="'+this.gettingMedicalsURL+'"><span class="link__title">Getting an X-ray or medical examination</span></a></p>':"";return"There are no approved panel physicians in "+fieldOptionLabel+". To get your medical examination or chest X-ray:\n<ul>\n    <li>visit a panel physician in a nearby country to get your results to us quickly, or</li>\n    <li>visit any registered doctor &mdash; you need to give the doctor the correct medical certificate form to complete.</li>\n</ul>\n"+healthEvidenceHtml+gettingMedicalsHtml}return"There are no results for the specified "+field.placeholder};inz.tools.LocalTool.prototype._getNoResultsTitle=function(){return this.noResultsTitle===void 0?this.entityTitle:this.noResultsTitle};inz.tools.PoliceCertsTool=function(data,options){inz.tools.PoliceCertsTool.parent.constructor.apply(this,[options]);this.includeResetButton=false;this.data=data};inz.tools._extend(inz.tools.PoliceCertsTool,inz.tools.Tool);inz.tools.PoliceCertsTool.prototype.getInitialFields=function(){var options=[];for(var d=0;d<this.data.length;d++){options.push({label:this.data[d].country_name,value:this.data[d].country_id})}return[{type:"select",placeholder:"Country",name:"country",required:true,options:options}]};inz.tools.PoliceCertsTool.prototype.search=function(fieldData,callback){if(this.debug){console.log("fieldData",fieldData);var original_callback=callback;callback=function(o2){console.log("search result: ",o2);original_callback(o2)}}var errors=this.validateFieldData(fieldData);if(errors.length){callback({type:"VALIDATION FAIL",errors:errors});return}var entry=inz.tools._getProperties(this.data,"@country_id="+inz.tools._getProperties(fieldData,"@name=country/value",true),true);if(!entry){callback({type:"NO RESULTS",entityTitle:"Police Certificates",message:"<p>There is no information for the country you selected.</p>"});return}var fields=inz.tools._getProperties(entry,"fields",true);var fieldValues={};if(fields){var missingFields=[];errors=[];for(var f=0,field,fieldDataItem,error;f<fields.length;f++){field=fields[f];fieldDataItem=inz.tools._getProperties(fieldData,"@name="+field.name,true);if(!fieldDataItem){missingFields.push(field);continue}error=this._validateField(fieldData,field);if(error){errors.push(error);continue}fieldValues[field.name]=fieldDataItem.value}if(missingFields.length){callback({type:"FIELDS",fields:missingFields});return}if(errors.length){callback({type:"VALIDATION FAIL",errors:errors});return}}function _filterMatches(filter,fieldValues2){for(var n2=0;n2<filter.length;n2++){var failedMatch=false;for(var key in filter[n2]){if(filter[n2].hasOwnProperty(key)){if(fieldValues2[key]!=filter[n2][key]){failedMatch=true;break}}}if(!failedMatch){return true}}return false}var subtitle=null;if(entry.subtitles){for(var s=0;s<entry.subtitles.length;s++){if(entry.subtitles[s].filter&&_filterMatches(entry.subtitles[s].filter,fieldValues)){subtitle=entry.subtitles[s].text;break}}}var resultData=[];if(entry.data){for(var d=0;d<entry.data.length;d++){if(entry.data[d].filter&&!_filterMatches(entry.data[d].filter,fieldValues)){continue}resultData.push({title:entry.data[d].title,body:entry.data[d].body})}}var changeFilterFields=inz.tools._getProperties(entry,"fields",true);if(changeFilterFields){changeFilterFields=JSON.parse(JSON.stringify(changeFilterFields));for(var n=0;n<changeFilterFields.length;n++){if(fieldValues[changeFilterFields[n].name]){switch(changeFilterFields[n].type){case"text":changeFilterFields[n].value=fieldValues[changeFilterFields[n].name];break;case"select":for(var o=0;o<changeFilterFields[n].options.length;o++){if(changeFilterFields[n].options[o].value==fieldValues[changeFilterFields[n].name]){changeFilterFields[n].options[o].selected=true}}break}}}changeFilterFields.push({type:"hidden",name:"country",value:entry.country_id})}callback({type:"RESULTS OPEN",id:entry.country_id,title:entry.country_name,subtitle:subtitle,count:resultData.length,data:resultData,changeFilterFields:changeFilterFields});return};inz.tools.OFFTool=function(data,webServiceURL,options){this.promptForRegions=true;this.promptForCodependents=false;this.isStandaloneTool=true;inz.tools.OFFTool.parent.constructor.apply(this,[options]);this.includeResetButton=false;this.data=data;this.webServiceURL=webServiceURL;this.residenceCountryOptions=[];for(var n=0;n<this.data["residence_countries"].length;n++){this.residenceCountryOptions.push({label:this.data["residence_countries"][n].label,value:this.data["residence_countries"][n].value})}this.visaOrSchemeOptions=[];for(var n=0;n<this.data.visas_and_schemes.length;n++){this.visaOrSchemeOptions.push({label:this.data.visas_and_schemes[n].title,value:this.data.visas_and_schemes[n].uid})}this.codependentsOptions=[{label:"Yes",value:"Yes"},{label:"No",value:"No"}];this.NO_RESULTS={type:"NO RESULTS",entityTitle:"Office and Fees Finder",message:"<p>There are currently no products available that match the selections you have made.</p>"}};inz.tools._extend(inz.tools.OFFTool,inz.tools.Tool);inz.tools.OFFTool.prototype.getInitialFields=function(){if(this.data["visas_and_schemes"].length==1){return[]}return[{type:"select",placeholder:"Select a visa, service, or scheme",name:"visaOrScheme",required:true,options:this.visaOrSchemeOptions,widthHint:"full"}]};inz.tools.OFFTool.prototype.search=function(fieldData,callback){var addFields=[];var errors=this.validateFieldData(fieldData);var requireField=function(field){if(!inz.tools._getProperties(fieldData,"@name="+field.name,true)){addFields.push(field);return null}var value=inz.tools._getProperties(fieldData,"@name="+field.name+"/value",true);var found=false;if(value==""){if(field.required){errors.push({name:field.name,text:field.placeholder+" is required"});return null}found=true}for(var n2=0;!found&&n2<field.options.length;n2++){if(field.options[n2].value==value){found=true}}if(!found){errors.push({name:field.name,text:field.placeholder+" is not a valid value"});return null}return value};var checkForIssues=function(){if(errors.length){callback({type:"VALIDATION FAIL",errors:errors});return true}if(addFields.length){callback({type:"FIELDS",fields:addFields});return true}return false};var visaOrScheme=null;if(this.data["visas_and_schemes"].length==1){visaOrScheme=this.data["visas_and_schemes"][0]}else{if(checkForIssues()){return}var visaOrSchemeValue=inz.tools._getProperties(fieldData,"@name=visaOrScheme/value",true);visaOrScheme=inz.tools._getProperties(this.data["visas_and_schemes"],"@uid="+visaOrSchemeValue,true)}var nationality=null;if(this._is_nationality_filter_required(visaOrScheme)){nationality=requireField({type:"select",placeholder:"Nationality on passport",name:"nationality",required:true,options:this.data["citizenship_countries"],widthHint:this._is_residence_filter_required(visaOrScheme)?"half":"full"})}if(this._is_residence_filter_required(visaOrScheme)){var residenceCountryValue=requireField({type:"select",placeholder:"Location when you apply",name:"residence",required:true,options:this.residenceCountryOptions,widthHint:"half"});if(residenceCountryValue!=null&&this.promptForRegions){var country=inz.tools._getProperties(this.data["residence_countries"],"@value="+residenceCountryValue,true);if(country["regions"]){var regionOptions=[];for(var n=0;n<country["regions"].length;n++){regionOptions.push({label:country["regions"][n],value:country["regions"][n]})}var residenceRegionValue=requireField({type:"select",placeholder:"Region",name:"region",required:true,options:regionOptions,widthHint:"full"})}}}if(checkForIssues()){return}var productSets=this._getProductSets(visaOrScheme,nationality);var productSet=null;switch(productSets.length){case 0:callback(this.NO_RESULTS);return;case 1:productSet=productSets[0];break;default:var groupNameOptions=[];for(var n=0;n<productSets.length;n++){groupNameOptions.push({label:productSets[n]["groupName"],value:productSets[n]["groupName"]})}var groupNameValue=requireField({type:"select",placeholder:"Preferred method of submission",name:"groupName",required:true,options:groupNameOptions,widthHint:"full"});if(checkForIssues()){return}productSet=inz.tools._getProperties(visaOrScheme["productSets"],"@groupName="+groupNameValue,true)}var selectionValue=null;if(productSet["selectionValues"]){var selectionValues=this._getSelectionValues(productSet,nationality);switch(selectionValues.length){case 0:callback(this.NO_RESULTS);return;case 1:selectionValue=selectionValues[0];break;default:var selectionValueOptions=[];for(var n=0;n<selectionValues.length;n++){selectionValueOptions.push({label:selectionValues[n]["value"],value:selectionValues[n]["value"]})}var selectionValueValue=requireField({type:"select",placeholder:productSet["selectionLabel"],name:"selectionValue",required:true,options:selectionValueOptions,widthHint:"full"});if(checkForIssues()){return}selectionValue=inz.tools._getProperties(productSet["selectionValues"],"@value="+selectionValueValue,true)}}if(checkForIssues()){return}var questions=selectionValue==null?productSet["questions"]:selectionValue["questions"];var qValues=null;if(questions){qValues=[];for(var i=0;i<questions.length;i++){var options=[];for(var n=0;n<questions[i].a.length;n++)options.push({label:questions[i].a[n].n,value:questions[i].a[n].v});var qValue=requireField({type:"select",placeholder:questions[i].q,name:"q"+i,required:true,options:options,widthHint:"full"});if(checkForIssues())return;qValues.push(qValue)}}this._performWebServiceCall(visaOrScheme,nationality,residenceCountryValue,residenceRegionValue,null,productSet["groupName"],selectionValue?selectionValue["value"]:null,qValues,callback)};inz.tools.OFFTool.prototype._performWebServiceCall=function(visaOrSchemeUID,citizenship,residenceCountry,residenceRegion,codependents,groupName,selectionValue,qValues,callback){function param(value){return value!=null?encodeURIComponent(value):""}var query=this.webServiceURL+"?uid="+param(visaOrSchemeUID["uid"])+"&citizenship="+param(citizenship)+"&residenceCountry="+param(residenceCountry)+"&residenceRegion="+param(residenceRegion)+"&groupName="+param(groupName)+"&selectionValue="+param(selectionValue)+(codependents?"&codependents="+param(codependents):"");if(qValues&&qValues.length){for(var i=0;i<qValues.length;i++)query+="&qs[]="+param(qValues[i])}var standaloneTool=this.isStandaloneTool;var xhr=new XMLHttpRequest;xhr.open("GET",query);xhr.onload=function(){if(xhr.status===200){var data=JSON.parse(xhr.responseText);if(!standaloneTool&&data.type==="RESULTS_OFF"){for(var n=0;n<data.stages.length;n++){data.stages[n].timeFrames=null}}callback(data)}else{callback({type:"ERROR",title:"Error",message:"<p>We were unable to complete your request at this time. Please try again later.</p>"})}};xhr.send()};inz.tools.OFFTool.prototype._is_nationality_filter_required=function(visaOrScheme){return true};inz.tools.OFFTool.prototype._is_residence_filter_required=function(visaOrScheme){return true};inz.tools.OFFTool.prototype._getProductSets=function(visaOrScheme,nationality){var productSets=[];for(var n=0;n<visaOrScheme["productSets"].length;n++){if(visaOrScheme["productSets"][n]["citizenshipRestrictions"]==null||visaOrScheme["productSets"][n]["citizenshipRestrictions"].indexOf(nationality)>=0){productSets.push(visaOrScheme["productSets"][n])}}return productSets};inz.tools.OFFTool.prototype._getSelectionValues=function(productSet,nationality){var selectionValues=[];for(var n=0;n<productSet["selectionValues"].length;n++){if(productSet["selectionValues"][n]["citizenshipRestrictions"]==null||productSet["selectionValues"][n]["citizenshipRestrictions"].indexOf(nationality)>=0){selectionValues.push(productSet["selectionValues"][n])}}return selectionValues};inz.tools.AJAXTool=function(endpointURL,initialFields,entityTitle,options){inz.tools.AJAXTool.parent.constructor.apply(this,[options]);this.endpointURL=endpointURL;this.initialFields=initialFields;this.entityTitle=entityTitle};inz.tools._extend(inz.tools.AJAXTool,inz.tools.Tool);inz.tools.AJAXTool.prototype.getInitialFields=function(){return this.initialFields};inz.tools.AJAXTool.prototype.search=function(fieldData,callback){var self=this;$.ajax(this.endpointURL,{cache:true,data:fieldData,error:function(xhr,status,error){callback({type:"ERROR",title:"ERROR",message:"<p>"+self["errorMessageUnexpectedError"]+"</p>"})},success:function(data,status,xhr){if(data){callback(data);return}callback({type:"ERROR",title:"ERROR",message:"<p>"+self["errorMessageUnexpectedError"]+"</p>"})}})};inz.tools.AccEmp2023RemoteSearchAPITool=function(endpointURL,initialFields,entityTitle,options){inz.tools.AccEmp2023RemoteSearchAPITool.parent.constructor.apply(this,[endpointURL,initialFields,entityTitle,options]);this.currentPage=0;this.lastKeyword=null};inz.tools._extend(inz.tools.AccEmp2023RemoteSearchAPITool,inz.tools.AJAXTool);inz.tools.AccEmp2023RemoteSearchAPITool.prototype.search=function(fieldData,callback){var keyword;var page;for(var n=0;n<fieldData.length;n++){var fd=fieldData[n];switch(fd.name){case"keywords":keyword=fd.value;break;case"__page__":page=fd.value;break}}if(page){this.currentPage=page}if(keyword!==this.lastKeyword){this.lastKeyword=keyword;this.currentPage=1}if(keyword.length<3){callback({"type":"NO RESULTS","entityTitle":"Accredited Employers","message":"<p>"+this.errorMessageKeywordTooShort+"</p>"});return}var self=this;$.ajax(this.endpointURL+keyword,{cache:false,data:{page:this.currentPage},headers:this.ajaxHeaders,error:function(xhr,status,error){var errorMessage=status==="timeout"?"The remote search API has timed out.<br>Please try again later.":self["errorMessageUnexpectedError"];callback({type:"ERROR",title:"ERROR",message:"<p>"+errorMessage+"</p>"})},success:function(data,status,xhr){if(data){callback(self.parseAPIData(data));return}callback({type:"ERROR",title:"ERROR",message:"<p>"+self["errorMessageUnexpectedError"]+"</p>"})},timeout:2e3})};inz.tools.AccEmp2023RemoteSearchAPITool.prototype.parseAPIData=function(data){if(Object.hasOwn(data,"errorDescription")){return{type:"ERROR",title:"ERROR",message:"<p>"+data["errorDescription"]+"</p>"}}if(data.totalCount===0){return{"type":"NO RESULTS","entityTitle":"Accredited Employers","message":"<p>"+this.errorMessageNoResults+"</p>"}}if(data.items.length===0){return{"type":"NO RESULTS","entityTitle":"Accredited Employers","message":"<p>"+this["errorMessageTooManyResults"]+"</p>"}}var itemsData=[];for(var n=0;n<data.items.length;n++){var d=data.items[n];var o={id:(data.page-1)*data.pageSize+n,title:d["employerName"]};if(d["tradingName"]){o["secondary_data"]=[{type:"couplet",title:"Trading name",body:d["tradingName"]}]}var details=[];if(d["nzbn"]){details.push({type:"couplet",title:"New Zealand Business Number (NZBN)",body:d["nzbn"]})}details.push({type:"couplet",title:"Expiry date of employer's accreditation",body:new Date(d["expiryDateOfAccreditation"]).toLocaleDateString("en-NZ",{year:"numeric",month:"long",day:"numeric"})});o["details"]=details;itemsData.push(o)}return{type:"RESULTS_PAGED",entityTitle:"Accredited Employers",hasGeolocatedResults:false,count:itemsData.length,currentPage:data.page,pageSize:data.pageSize,totalCount:data.totalCount,hasMoreResults:data.page*data.pageSize<data.totalCount,data:itemsData}};
